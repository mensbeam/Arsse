pkgname="arsse"
pkgver=0.9.1.r14.e2b182e
pkgrel=1
epoch=
pkgdesc="RSS/Atom newsfeed synchronization server"
arch=("any")
url="https://thearsse.com/"
license=("MIT")
groups=()
depends=()
makedepends=("git" "php" "php-intl" "composer")
checkdepends=()
optdepends=("php-pgsql: PostgreSQL database support"
            "nginx: HTTP server"
            "apache: HTTP server")
provides=()
conflicts=()
replaces=()
backup=("etc/webapps/arsse/config.php" "etc/php/php-fpm.d/arsse.conf")
options=()
install=
changelog=
source=("git+file://$(dirname $(dirname $(pwd)))")
noextract=()
md5sums=("SKIP")

pkgver() {
    git describe --tags | sed 's/\([^-]*-\)g/r\1/;s/-/./g'
}

build() {
    cd "$srcdir/arsse"
    composer install
    ./robo manual
    composer install --no-dev -o -n --no-scripts
    php arsse.php conf save-defaults config.defaults.php
    rm -r vendor/bin
}

package() {
    depends=("php" "php-intl" "php-sqlite" "php-fpm")
    cd "$srcdir/arsse"
    install -DTm755 dist/arch/arsse.sh "$pkgdir/usr/bin/arsse"
    install -D lib locale sql vendor www CHANGELOG UPGRADING README.md arsse.php "$pkgdir/usr/share/webapps/arsse"
    install -D manual/* "$pkgdir/usr/share/doc/arsse"
    install -D LICENSE AUTHORS "$pkgdir/usr/share/licenses/arsse"
    install -D dist/arch/*.service "$pkgdir/usr/lib/systemd/system"
    install -DT dist/arch/sysuser.conf "$pkgdir/usr/lib/sysusers.d/arsse.conf"
    install -DT dist/arch/php-fpm.conf "$pkgdir/etc/php/php-fpm.d/arsse.conf"
    install -Dm640 dist/arch/config.php "$pkgdir/etc/webapps/arsse"
    install -D config.defaults.php "$pkgdir/etc/webapps/arsse"
    install -D dist/arch/nginx/* "$pkgdir/etc/webapps/arsse/nginx"
    ln -sT "/etc/webapps/arsse/config.php" "usr/share/webapps/arsse/config.php"
}
